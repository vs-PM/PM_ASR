# ──────────────────────────────────────────────────────────────────────
# 1️⃣  Базовый CUDA‑образ
FROM nvidia/cuda:12.3.2-cudnn9-runtime-ubuntu22.04

# ──────────────────────────────────────────────────────────────────────
# 2️⃣  Минимум Python + необходимые утилиты
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        python3.10 \
        python3-pip \
        ffmpeg \
        libsndfile1 \
    && rm -rf /var/lib/apt/lists/*

# ──────────────────────────────────────────────────────────────────────
# 3️⃣  Путь к библиотекам CUDA
ENV LD_LIBRARY_PATH=/usr/local/cuda/lib64

# ──────────────────────────────────────────────────────────────────────
# 4️⃣ Устанавливаем все зависимости из requirements.txt
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# ──────────────────────────────────────────────────────────────────────
# 5️⃣  Копируем исходный код
COPY . .

# ──────────────────────────────────────────────────────────────────────
# 6️⃣  Запуск приложения
CMD ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "7000"]